## data source definition
#############################################################################

source jobs2_db {
	type					= mysql

	sql_host				= 127.0.0.1
	sql_user				= root
	sql_pass				= root
	sql_db					= mtest
	sql_port				= 3306	# optional, default is 3306

	sql_query				= SELECT id FROM cvs

	sql_ranged_throttle		= 100
}

source admin_search_employers : jobs2_db
{
    sql_range_step = 512550
    sql_query_range = SELECT UNIX_TIMESTAMP(min(modification_timestamp)), UNIX_TIMESTAMP(max(modification_timestamp)) FROM jobs

	sql_query				= \
		SELECT \
			j.id, \
			employer_name AS employer_name, \
			employers.name AS parent_employer_name, \
			j.employer_id, \
			j.title, \
			j.reference_number, \
			j.education_level_id, \
			concat('catid', group_concat(distinct jsc.job_category_id SEPARATOR ' catid')) AS job_category_ids, \
			j.country_id as country_id_field, \
			j.city_id, \
			j.state_id, \
			j.country_id, \
			j.original_job_category_id, \
			j.is_suspended, \
			UNIX_TIMESTAMP(j.modification_timestamp) AS modification_timestamp, \
			UNIX_TIMESTAMP(j.modification_timestamp) AS creation_date_timestamp, \
			UNIX_TIMESTAMP(original_creation_date) AS original_creation_date_timestamp, \
			j.xml_id, \
			j.display_status \
		FROM  \
			jobs j FORCE INDEX(modification_timestamp) \
				STRAIGHT_JOIN employers \
					ON j.employer_id = employers.id \
				LEFT JOIN job_selected_categories jsc \
					ON j.id = jsc.job_id \
		WHERE j.modification_timestamp >= FROM_UNIXTIME($start) \
			AND j.modification_timestamp <= FROM_UNIXTIME($end) \
			AND expiry_date > NOW() \
		GROUP BY j.id

	sql_attr_bool = is_suspended
	sql_attr_uint = display_status
	sql_attr_uint = education_level_id
	sql_attr_uint = employer_id
	sql_attr_uint = city_id
	sql_attr_uint = state_id
	sql_attr_uint = country_id
	sql_attr_uint = modification_timestamp
	sql_attr_uint = creation_date_timestamp
	sql_attr_uint = original_job_category_id
	sql_attr_uint = xml_id
	sql_attr_uint = original_creation_date_timestamp


	sql_attr_multi = uint job_categories from ranged-main-query; \
	SELECT SQL_NO_CACHE job_id, job_category_id \
	FROM job_selected_categories JOIN jobs ON jobs.id = job_id \
	WHERE modification_timestamp >= FROM_UNIXTIME($start) AND modification_timestamp <= FROM_UNIXTIME($end)
}



#############################################################################
## index definition
#############################################################################


index admin_search_employers
{
    access_plain_attrs      = mlock
    access_blob_attrs       = mlock
    access_doclists         = mlock
    access_hitlists         = mlock
    morphology				= lemmatize_en
    morphology_skip_fields 	= employer_name, parent_employer_name, reference_number, job_category_ids
    stored_fields           = title, employer_name, parent_employer_name
    index_exact_words       = 1
    expand_keywords         = 1
    min_infix_len 			= 2
    min_word_len			= 2
    html_strip				= 0
    charset_table           = non_cjk
    exceptions		        = /work/l4g/misc/manticore/jobs_exceptions.txt
    stopwords               = /work/l4g/misc/manticore/stopwords.txt
    stopwords_unstemmed		= 1
    source			        = admin_search_employers
    path			        = /tmp/admin_search_employers
}


index admin_search_employers_rt:admin_search_employers {
    type = rt
    rt_mem_limit 			= 16M
    path                    = /tmp/admin_search_employers_rt

	stored_fields 			= employer_name, parent_employer_name, title

    rt_field 				= employer_name
    rt_field 				= parent_employer_name
    rt_field 				= title
    rt_field 				= reference_number
    rt_field 				= job_category_ids
    rt_field 				= country_id_field

    rt_attr_uint 			= employer_id
    rt_attr_uint 			= education_level_id
    rt_attr_uint 			= city_id
    rt_attr_uint 			= state_id
    rt_attr_uint 			= country_id
    rt_attr_uint 			= original_job_category_id
	rt_attr_bool 			= is_suspended
    rt_attr_uint 			= modification_timestamp
    rt_attr_uint 			= creation_date_timestamp
    rt_attr_uint 			= original_creation_date_timestamp
    rt_attr_uint 			= xml_id
    rt_attr_uint 			= display_status
    rt_attr_multi 			= job_categories
}



#############################################################################
## indexer settings
## Max memory for indexer is 2047Mb internal limit
#############################################################################

indexer
{
	mem_limit				= 2046M
	lemmatizer_cache 		= 256M
}

#############################################################################
## common settings
#############################################################################

common
{
	lemmatizer_base		= /work/l4g/misc/manticore/dict/
}

#############################################################################
## searchd settings
#############################################################################
        #Sometimes need to inspect slow queries by enabling log
        #log = /var/log/manticore/searchd.log
        #query_log = /var/log/manticore/query.log
        #pid_file = /var/run/manticore/searchd.pid
        #data_dir is used ONLY IN RT_MODE, we use plain_mode
        #data_dir = /var/lib/manticore
        #query_log_format = sphinxql

searchd
{
	max_open_files          = 10000
	network_timeout			= 5
	client_timeout			= 300
	threads					= 52
	net_workers             = 1
	read_buffer_docs        = 256K
    read_buffer_hits        = 256K
	pid_file				= /tmp/searchd.pid
	seamless_rotate			= 1
	preopen_indexes			= 1
	unlink_old				= 1
	max_packet_size			= 8M
	max_filters				= 256
	max_filter_values		= 4096
	expansion_limit 		= 10
	log 					= /tmp/searchd.log
	binlog_path 			= /tmp/data
	query_log 				= /tmp/query.log
	query_log_format		= sphinxql
	listen = 5877:mysql
	listen = 5878
}

# --eof--
